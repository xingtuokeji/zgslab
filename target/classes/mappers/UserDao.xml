<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.simtop.dao.UserDao">
    <resultMap id="result" type="com.simtop.pojo.User">
        <id property="id" column="tu.id"/>
        <result property="email" column="email"/>
        <result property="province" column="province"/>
        <result property="city" column="city"/>
        <result property="username" column="username"/>
        <result property="password" column="password"/>
        <result property="loginName" column="login_name"/>
        <result property="school" column="school"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="address" column="address"/>
        <association property="roleId" column="id" javaType="com.simtop.pojo.Role">
            <result property="id" column="tr.id"/>
            <result property="roleName" column="role_name"/>
        </association>
    </resultMap>
    <select id="checkLoginName" parameterType="string" resultType="int">
        select count(1) from tb_user
        where login_name=#{loginName}
    </select>
    <select id="checkEmail" parameterType="string" resultType="int">
        select count(1) from tb_user
        where email=#{email}
    </select>
    <insert id="insert" parameterType="com.simtop.pojo.User">
        insert into tb_user(username, login_name, password,email, role_id, create_time, update_time,school,province,city)
        values (#{username},#{loginName},#{password},#{email},#{roleId},now(),now(),#{school},#{province},#{city})
    </insert>
    <select id="checkLoginNameOrEmail" parameterType="map" resultType="com.simtop.pojo.User">
        select id,username,login_name,password,email,role_id,create_time,update_time,
        school,province,city from tb_user
        where login_name=#{loginName} or email=#{email}
    </select>
    <update id="updatePasswordByEmail" parameterType="com.simtop.pojo.User">
        update tb_user set password=#{password}
        where email=#{email}
    </update>

    <select id="selectAll" resultMap="result">
        select tu.id 'tu.id',tu.username,tu.login_name,tu.password,tu.email,tr.id 'tr.id',tu.create_time,tu.update_time,
        tu.school,tu.province,tu.city,tu.address from tb_user tu left join tb_role tr on tu.role_id=tr.id
    </select>

    <select id="selectByParams" parameterType="com.simtop.pojo.User" resultMap="result">
        select tu.id 'tu.id',tu.username,tu.login_name,tu.password,tu.email,tr.id 'tr.id',tu.create_time,tu.update_time,
        tu.school,tu.province,tu.city,tu.address from tb_user tu left join tb_role tr on tu.role_id=tr.id
        <where>
            <if test="username!=null and username!=''">and username like concat(concat('%',#{username}),'%')</if>
            <if test="loginName!=null and loginName!=''">and login_name like concat(concat('%',#{loginName}),'%')</if>
            <if test="school!=null and school!=''">and school like concat(concat('%',#{school}),'%')</if>
        </where>
    </select>

    <insert id="insertBackUser" parameterType="com.simtop.pojo.User">
        insert into tb_user(username, login_name, password, email, role_id, create_time, update_time, school,address)
        values (#{username},#{loginName},#{password},null,#{email},#{roleId.id},now(),now(),#{school},#{address})
    </insert>

    <delete id="deleteByUserId" parameterType="int">
        delete from tb_user
        where id=#{id}
    </delete>

    <update id="updateBackendUser" parameterType="com.simtop.pojo.User">
        update tb_user
        <set>
            <if test="username!=null and username!=''">username=#{username},</if>
            <if test="loginName!=null and loginName!=''">login_name=#{loginName},</if>
            <if test="password!=null and password!=''">password=#{password},</if>
            <if test="email!=null and email!=''">email=#{email},</if>
            <if test="school!=null and school!=''">school=#{school},</if>
            <if test="address!=null and address!=''">address=#{address}</if>
        </set>
        where id=#{id}
    </update>

</mapper>    
  